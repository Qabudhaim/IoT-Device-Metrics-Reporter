{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="max-w-5xl mx-auto p-6">
  <!-- Cover Image -->
  <img src="{% static 'img/background.jpg' %}" alt="Device Cover" class="w-full h-48 object-cover rounded-md shadow mb-6" />

  <!-- Network info and metrics container -->
  <div id="metrics-container"></div>

  <!-- Chart container -->
  <canvas id="cpuChart" class="w-full h-64 bg-white rounded shadow p-2 mt-8"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const deviceUuid = "{{ device_id }}"; // Assume you pass the device UUID from Django context
  const metricsContainer = document.getElementById('metrics-container');
  const cpuCtx = document.getElementById('cpuChart').getContext('2d');

  let cpuChart;
  let cpuData = {
    labels: [],
    datasets: [{
      label: 'CPU Usage (%)',
      data: [],
      borderColor: 'rgb(37 99 235)', // Tailwind blue-600
      backgroundColor: 'rgba(37, 99, 235, 0.3)',
      fill: true,
      tension: 0.3,
      pointRadius: 0,
    }]
  };

  function createCpuChart() {
    cpuChart = new Chart(cpuCtx, {
      type: 'line',
      data: cpuData,
      options: {
        responsive: true,
        animation: false,
        scales: {
          y: {
            min: 0,
            max: 100,
            ticks: {
              stepSize: 10,
              color: '#4B5563' // Tailwind gray-600
            },
            grid: {
              color: '#E5E7EB' // Tailwind gray-200
            }
          },
          x: {
            ticks: {
              color: '#4B5563'
            },
            grid: {
              display: false
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: '#374151' // Tailwind gray-700
            }
          }
        }
      }
    });
  }

    function isOnline(updatedAtISO) {
    const updatedAt = new Date(updatedAtISO);
    const now = new Date();
    const diffMs = now - updatedAt; // diff in milliseconds
    return diffMs <= 60 * 1000; // 1 minute = 60000 ms
  }

  function updateCpuChart(cpuUsage) {
    const now = new Date();
    const label = now.toLocaleTimeString();

    cpuData.labels.push(label);
    cpuData.datasets[0].data.push(cpuUsage);

    if (cpuData.labels.length > 20) { // keep last 20 points
      cpuData.labels.shift();
      cpuData.datasets[0].data.shift();
    }
    cpuChart.update();
  }

  async function fetchDeviceMetrics() {
    try {
      const res = await fetch(`http://127.0.0.1:8000/api/devices/${deviceUuid}/`);
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

      const json = await res.json();
      const device = json.data.device;

      const sys = (device.system_metrics && device.system_metrics[0]) || {};
      const net = (device.network_metrics && device.network_metrics[0]) || {};

      const online = sys?.updated_at ? isOnline(sys.updated_at) : false;
      const statusText = online ? 'Online' : 'Offline';
      const statusClass = online ? 'text-green-600 font-bold' : 'text-red-600 font-bold';

      // Build HTML for metrics
      const html = `
        <div class="bg-white p-4 rounded shadow mb-6">
            <h3 class="text-lg font-semibold mb-2">Network Information</h3>
            <p><strong>Interface:</strong> <span class="font-mono">${net?.interface ?? 'N/A'}</span></p>
            <p><strong>IP Address:</strong> <span class="font-mono">${net?.ip_address ?? 'N/A'}</span></p>
            <p><strong>MAC Address:</strong> <span class="font-mono">${net?.mac_address ?? 'N/A'}</span></p>
            <p class="${statusClass}"><strong>Status:</strong> ${statusText}</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-white p-4 rounded shadow">
            <h3 class="text-lg font-semibold mb-4">System Metrics</h3>
            <p><strong>Uptime:</strong> ${sys.uptime?.toFixed(2) ?? 'N/A'} s</p>
            <p><strong>CPU Usage:</strong> ${sys.cpu_usage ?? 'N/A'} %</p>
            <p><strong>Memory Usage:</strong> ${sys.memory_percent ?? 'N/A'} % <span class="text-gray-500 text-sm">(${sys.memory_kb ? (sys.memory_kb / 1024).toFixed(2) + ' MB' : 'N/A'})</span></p>
            <p><strong>Disk Usage:</strong> ${sys.disk_percent ?? 'N/A'} % <span class="text-gray-500 text-sm">(${sys.disk_kb ? (sys.disk_kb / (1024*1024)).toFixed(2) + ' GB' : 'N/A'})</span></p>
          </div>

          <div class="bg-white p-4 rounded shadow">
            <h3 class="text-lg font-semibold mb-4">Load Averages & Network Traffic</h3>
            <p><strong>Load Average (1 min):</strong> ${sys.load_1 ?? 'N/A'}</p>
            <p><strong>Load Average (5 min):</strong> ${sys.load_5 ?? 'N/A'}</p>
            <p><strong>Load Average (15 min):</strong> ${sys.load_15 ?? 'N/A'}</p>
            <hr class="my-3" />
            <p><strong>RX Bytes:</strong> ${net.rx_bytes?.toLocaleString() ?? 'N/A'}</p>
            <p><strong>TX Bytes:</strong> ${net.tx_bytes?.toLocaleString() ?? 'N/A'}</p>
            <p><strong>RX Packets:</strong> ${net.rx_packets?.toLocaleString() ?? 'N/A'}</p>
            <p><strong>TX Packets:</strong> ${net.tx_packets?.toLocaleString() ?? 'N/A'}</p>
          </div>
        </div>
      `;

      metricsContainer.innerHTML = html;

      // Update chart with new CPU usage if available
      if (sys.cpu_usage != null) {
        updateCpuChart(sys.cpu_usage);
      }
    } catch (err) {
      console.error('Failed to fetch device metrics:', err);
      metricsContainer.innerHTML = `<p class="text-red-600">Failed to load device metrics.</p>`;
    }
  }

  // Initialize chart and start fetching loop
  createCpuChart();
  fetchDeviceMetrics();
  setInterval(fetchDeviceMetrics, 2500);
</script>
{% endblock %}